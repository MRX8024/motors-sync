## Добро пожаловать в проект синхронизации шаговых двигателей для AWD систем

### В данный момент программа поддерживает следующие кинематики:
`CoreXY` / `Cartesian` `4 WD`

### Как это работает?
В системах AWD один ремень приводится в движение двумя двигателями и
разделяется шкивами на два контура. Двигатели при активации некорректно
восстанавливают свою предыдущую позицию: ремень на одном контуре
растягивается, а на другом ослабевает. Синхронизация заключается в
выравнивании натяжения этих двух контуров. При отключении одного из
двигателей, натяжение контуров выравнивается и его ротор проворачивается.
При повторной активации этот ротор возвращается в предыдущую позицию с
характерным ударом. Сила этого удара зависит от разницы в натяжении между
контурами. Чем больше разница, тем сильнее удар; если разница минимальна,
удара не происходит. Магнитуду ударов измеряет акселерометр, постоянно
закрепленный на каретке, либо энкодер, прикрепленный к мотору. Синхронизация
софтовая, а значит сбрасывается при отключении любого из шаговых двигателей
на контуре ремня. Скрипт определяет направление вращения ротора, постепенно
подстраивает его положение, пока магнитуда удара уменьшается. Если она
начинает расти, то происходит откат к предыдущей позиции и синхронизация
завершается, либо совершает дополнительные итерации, для достижения
заданного порога магнитуды n-ное кол-во раз.

### Примечания:
* Рекомендуется жестко фиксировать акселерометр в ближайшей точке к
  креплению ремней каретки. Крепление в других местах, например
  использование акселерометра CAN-платы или Beacon-а на пластичном 
  креплении, может привести к искажению измерений.

* Не рекомендуется использовать акселерометр `lis2dw` ввиду малой
  частоты дискретизации, он может плохо определять пики колебаний,
  однако его работа оптимизирована отключением фильтрации данных.

* Не включайте нагрев хотенда во время синхронизации. Работающий
  вентилятор (в целом любой вентилятор в принтере) может помешать
  корректному и более точному измерению. Измерить/cравнить шумы вы
  можете стандартной командой клиппера - [MEASURE_AXES_NOISE
  ](https://www.klipper3d.org/G-Codes.html#measure_axes_noise)

* В большинстве случаев не стоит повышать значение параметра синхронизации 
  `microsteps` выше 16 при 20т шкиве, разница между магнитудой соседних
  положений ротора будет мизерна, что может дать ложную калибровку.

### Установка скрипта калибровки на хост принтера
```
cd ~
git clone https://github.com/MRX8024/motors-sync
bash ~/motors-sync/install.sh
```

###  Конфигурация
Большинство параметров поддерживают само-указание под ось, например при
`axes: x,y` параметр `accel_chip` может быть описан как `accel_chip_x` и
`accel_chip_y`. Но `accel_chip` останется параметром по умолчанию, если
нет указания для конкретной оси. Это актуально для кинематики Cartesian,
которая может иметь разные реализации приводных узлов.

Параметры, начинающиеся с символа `#`, являются необязательными для
настройки. Они имеют базовые значения по умолчанию, которые указаны рядом
с ними, но могут быть модифицированы под разные конфигурации принтеров.
Рекомендуется ознакомиться со всеми возможными параметрами конфигурации,
перед началом пользования программы.

Добавляем в конфигурационный файл принтера раздел, и частично настраиваем
его для первого замера -

```
[motors_sync]
axes: x,y
#    Оси на которых будет производиться калибровка.
accel_chip:
#    Aкселерометр для сбора вибраций: adxl345 / mpu9250 и т.п.
#encoder_chip_<axis>:
#    Ось, присвоенное имя энкодеру, для замера отклонений.
#chip_filter: median
#    Тип фильтра данных акселерометра: 'median' обычно хватает, но особо
#    шумные принтеры (вентиляторов, и т.п.) могут потребовать более мощный
#    фильтр - 'kalman'. Для lis2dw фильтры отключены.
#median_size: 3
#    Размер окна медианного фильтра.
#kalman_coeffs: 1.1, 1., 1e-1, 1e-2, .5, 1.
#    Простые коэффициенты, описывающие фильтр Калмана.
#microsteps: 16
#    Максимальное дробление смещения ротора шагового двигателя.
#sync_method: default
#    Методы синхронизации двух осей во взаимосвязанной кинематике:
#    'alternately' - оси калибруются чередуясь, шаг за шагом. (default)
#    'synchronous' - оси калибруются в зависимости от своей магнитуды,
#    стараясь поддерживать её на одном уровене.
#    Методы синхронизации оси/осей в НЕвзаимосвязанной кинематике:
#    'sequential' - оси калибруются последовательно. (default)
#model: linear
#    Модель зависимости смещения микрошагов шагового двигателя от
#    величины измеренных колебаний. Поддерживаемые модели: linear
#    quadratic, power, root, hyperbolic, exponential.
#model_coeffs: 20000, 0
#    Коэффициенты выше описанной модели, для рассчета микрошагов.
#max_step_size: 3
#    Максимальное количество микрошагов на которые мотор может
#    передвинуться за раз, для достижения планируемой магнитуды.
#axes_steps_diff: 4
#    Разница позиций моторов в микрошагах между двумя осями, для
#    актуализации магнитуды вторичной оси. Используется в методе
#    synchronous, или в процессе выравнивания осей в методе alternately.
#    Типичное значение - max_step_size + 1.
#retry_tolerance: 0
#    Принудительный порог, до которого пара шаговых двигателей на одном
#    ремне, должна будет опустить величину колебаний. Рекомендуется к
#    настройке, дабы фильтровать возможные ошибки измерений. После
#    нескольких итераций запуска синхронизации вы найдете порог, до
#    которого можно опустить значение этого параметра.
#retries: 0
#    Максимальное количество повторений для достижения принудительного
#    порога колебаний.
#head_fan:
#    Вентилятор хотенда, который будет выключаться на время синхронизации
#    для исключения его шумов.
```

### Синхронизация моторов
Вводим команду `SYNC_MOTORS` в терминале, на главной странице веб
интерфейса, и ждем завершения процесса. Некоторые параметры можно
переопределять:
```
SYNC_MOTORS AXES=[<axes>] ACCEL_CHIP=[<chip_name>]
 [RETRY_TOLERANCE=<value>] [RETRIES=<value>]
```
Так же их можно указать под конкретную ось, например `ACCEL_CHIP_X`, в
ином случае будет переопределение параметра для выбранных или всех осей.

### Автоматизация
Синхронизация обычно запускается в начале печати, во время прогрева
принтера. Для этого нужно добавить ее в макрос \ слайсер. Например -
```
M140 S   ; set bed temp
SYNC_MOTORS
G28 Z
M190 S   ; wait for bed temp to stabilize
M104 S   ; set extruder temp
...
```

### Переменная статуса калибровки 
Вводится переменная статуса калибровки, которая сбрасывается при выключении
моторов принтера. Вы можете проверять её состояние внутри макроса. В случае
положительного статуса не делать лишний раз калибровку, если она была уже
выполнена в текущем сеансе. Для примера -
```
...
G28 X Y
{% if not printer.motors_sync.applied %}
    SYNC_MOTORS
{% endif %}
G28 Z
...
```

### Калибровка модели синхронизации
После того как вы убедились в должной работе всего процесса, у вас не
возникает случайных ошибочных измерений т.п., можно ускорить выполнение
синхронизации подбором подходящей модели зависимости микрошагов от величины
колебаний. Однако калибровщик разработан таким образом, что допускает некие
ошибочные измерения, и это не должно существенно повлиять на результаты
калибровки. Для этого вводим команду `SYNC_MOTORS_CALIBRATE` в терминал,
некоторые параметры так же можно переопределять:
```
SYNC_MOTORS_CALIBRATE AXIS=[<axis>] [PEAK_POINT=<value>] [REPEATS=<value>]
```
По умолчанию калибровка совершает 10 итераций повышения/понижения магнитуды
в диапазоне от `~0` до `rotation_distance * 1250`, шагая по 1 микрошагу.
После завершения вы увидите в терминале путь до графического изображения,
а так же математические модели и их параметры. Открываем файл и видим
примерно следующее -

![](/wiki/pictures/img_1.png)

Как в терминале, так и на графике в таблице указаны названия моделей и их
RMSE (среднеквадратичное отклонение) от измеренных точек, отсортированные
в порядке возрастания. Берем функцию наименьшую по отклонению к точкам, с
параметрами этой функции из терминала, и вписываем в конфигурационный файл.
Например -
```
model: exponential
model_coeffs:
    68002.9000704507,
    0.0293145933,
    -70739.3609995888
```

### Статистика калибровок
Каждая итерация синхронизации записывается в журнал, который располагается
в директории со скриптом. Это позволяет вывести статистику синхронизаций с
помощью следующей команды:
```
SYNC_MOTORS_STATS
```
Для очистки можно использовать команду:
```
SYNC_MOTORS_STATS CLEAR=true
```

### Синхронизация по энкодерам
Энкодеры обладают повышенной точностью вплоть до 1/128 шага, не зависят
от расположения принтера в пространстве и быстрее выполняют процесс
синхронизации. Поддерживаются любые энкодеры, описанные в [клиппер вики
](https://www.klipper3d.org/Config_Reference.html#angle), установить его
можно на любой из моторов в контуре ремня. После установки рекомендуется
выполнить возможные внутренние калибровки сенсора, и затем калибровку в
клиппере. По умолчанию количество микрошагов в шаге считается по длине
отклонения вала ротора, однако можно откалибровать модель синхронизации
так же, как и с акселерометром. Значение параметра `max_step_size` можно
завысить, так как это работает стабильнее, нежели с акселерометром, и
может сильно ускорить процесс синхронизации. Однако на некоторых принтерах
повышенное значение все еще может вызывать непредсказуемый результат.

### Контакты
Используйте систему issue на GitHub.
Вы также можете написать мне лично в Discord — @mrx8024.

### Немного истории:
Идея проекта родилась летом 2023 года. Тогда ее первый автор @altzbox
понял, что с помощью акселерометра можно измерить силу удара при активации
моторов. Комьюнити эту идею приняло без энтузиазма, а реализовать проект
самостоятельно ему мешал недостаточный уровень навыков в программировании.
Через полгода, устав от ручной синхронизации моторов, @altzbox решил
написать код с помощью ChatGPT, и в Январе 2024 года появилась первая
рабочая [версия](https://github.com/altzbox/motors_sync), но для
дальнейшего развития проекта навыков уже не хватало. Весной 2024 года,
я (@mrx8024) заинтересовался этой идеей и решил продолжить разработку.

### [Поддержать](https://ko-fi.com/altzbox) проект
