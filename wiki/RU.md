## Добро пожаловать в проект синхронизации шаговых двигателей для AWD систем

## О проекте:

### В данный момент программа поддерживает следующие кинематики:
`CoreXY / Cartesian` `4 WD`

Метода синхронизации заключается в измерении величины смещения (колебаний)
печатающей головки (каретки), при включении второго шагового двигателя,
располагающегося на одном ремне с первым. Второй мотор смещается до
ближайшего полного шага, тем самым растягивая и ослабляя ремень по двум
сторонам контура, из-за первого, удерживающего ремень, мотора. Удары
измеряет акселерометр, навсегда расположившийся на каретке, в зависимости
от типа кинематики. Синхронизация софтовая, а значит сбрасывается при
отключении любого из шаговых двигателей на контуре ремня.

Скрипт определяет направление движения, для уменьшения колебаний каретки.
Производит корректировку микрошагов до тех пор, пока величина смещений
уменьшается, т.е. пока мотор не начнет растягивание ремня в обратную
сторону. В этом случае калибровка завершается на микрошаге с наименьшей
величиной удара, либо совершает дополнительные итерации, для достижения
заданного порога колебаний n-ное кол-во раз.

Примечания:
1. Не включайте нагрев хотенда во время синхронизации. Работающий
   вентилятор (в целом любой вентилятор в принтере) может помешать
   корректному и более точному измерению. Измерить/cравнить шумы вы
   можете стандартной командой клиппера - [MEASURE_AXES_NOISE
   ](https://www.klipper3d.org/G-Codes.html#measure_axes_noise)
2. Не рекомендуется использовать акселерометр `lis2dw` ввиду малой
   частоты дискретизации, он может плохо определять пики магнитуд,
   однако его работа оптимизирована посредством отключения фильтрации.

### 1. Установка скрипта калибровки на хост принтера -

```
 cd ~
 git clone https://github.com/MRX8024/motors-sync
 bash ~/motors-sync/install.sh
```

2. Добавляем в конфигурационный файл раздел, и частично настраиваем
   его для первого замера -

```
[motors_sync]
axes: x,y
#    Оси на которых будет производиться калибровка.
accel_chip:
#    Aкселерометры для сбора вибраций: adxl345 / mpu9250 / lis2dw и т.п.
#    Указываются общие, либо под ось, на которой производится калибровка, 
#    например - accel_chip_x или accel_chip_y.
#chip_filter: median
#    Тип фильтра данных акселерометра: 'median' обычно хватает, но
#    особо шумные принтеры (вентиляторов, и т.п.) могут потребовать более
#    мощный фильтр - 'kalman'. Для lis2dw фильтры отключены.
#median_size: 3
#    Размер окна медианного фильтра.
#kalman_coeffs: 1.1, 1., 1e-1, 1e-2, .5, 1.
#    Простые коэффициенты, описывающие фильтр Калмана.
#microsteps: 16
#    Максимальное дробление смещения ротора шагового двигателя. Не стоит
#    повышать значение выше 16 при 20т шкиве, эти колебания неуловимы.
#sync_method: default
#    Методы синхронизации двух осей во взаимосвязанной кинематике:
#    'alternately' - оси перемещаются чередуясь, шаг за шагом.
#    'synchronous' - оси перемещаются в зависимости от своей магнитуды,
#    стараясь минимизировать разницу магнитуд осей.
#    Методы синхронизации оси/осей в НЕвзаимосвязанной кинематике:
#    'sequential' - оси калибруются последовательно.
#model: linear
#    Модель зависимости смещения микрошагов на валу шагового двигателя
#    от величины измеренных колебаний. Указываются общие, либо под
#    конкретную ось. Поддерживаемые модели: linear, quadratic, power,
#    root, hyperbolic, exponential.
#model_coeffs: 20000, 0
#    Коэффициенты выше описанной модели, для рассчета микрошагов.
#    Указываются общие, либо под конкретную ось.
#max_step_size: 3
#    Максимальное количество микрошагов на которые мотор может
#    передвинуться за раз, для достижения планируемой магнитуды.
#axes_steps_diff: 4
#    Только для метода synchronous синхронизации: разница микрошагов
#    между двумя осями, чтобы запустить дополнительную проверку 
#    актуальной магнитуды у более слабой оси. Типичное, а так же
#    минимальное значение - max_step_size + 1.
#retry_tolerance: 0
#    Принудительный порог, до которого пара шаговых двигателей на
#    одном ремне, должна будет опустить величину колебаний.
#    Рекомендуется к настройке, дабы фильтровать возможные неточости.
#    После нескольких итераций запуска синхронизации вы найдете грань,  
#    до которой нужно опустить этот параметр.
#retries: 0
#    Максимальное количество повторений для достижения принудительного
#    порога отклонений синхронизации моторов.
```
3. Синхронизация моторов:
   Вводим команду `SYNC_MOTORS` в терминале, на главной странице веб
   интерфейса, и ждем завершения процесса.

   Некоторые параметры можно переопределять:
   ```
   SYNC_MOTORS AXES=[<axes>] ACCEL_CHIP_<AXIS>=[<chip_name>]
    [RETRY_TOLERANCE=<value>] [RETRIES=<value>]
   ```
   Для удобства настройки дополнительных параметров можно добавить макрос
   из `motors_sync.cfg` для получения физических кнопок\ячеек в интерфейсе.
4. Синхронизация обычно запускается в начале печати, во время нагрева
   стола. Для этого нужно добавить ее в макрос \ слайсер. Например -
```
M140 S   ;set bed temp
SYNC_MOTORS
G28 Z
M190 S   ; wait for bed temp to stabilize
M104 S   ;set extruder temp
...
```
5. Так же вводится переменная статуса калибровки, которая сбрасывается при
   выключении моторов принтера. Вы можете запускать синхронизацию через
   `motors_sync.cfg`, который в себе имеет уже эту проверку, либо проверять
   её состояние внутри макроса. В случае положительного статуса не делать
   лишний раз калибровку, если она была уже выполнена в текущем сеансе. 
   Для примера -
```
...
G28 X Y
{% if not printer.motors_sync.applied %}
    SYNC_MOTORS
{% endif %}
G28 Z
...
```
### Калибровка модели синхронизации -
После того как вы убедились в должной работе всего процесса, у вас не
возникает случайных ошибочных измерений т.п., можно ускорить выполнение
синхронизации подбором подходящей модели зависимости микрошагов от
величины колебаний. Для этого вводим команду `SYNC_MOTORS_CALIBRATE` в
терминал, некоторые параметры так же можно переопределить:
```
SYNC_MOTORS_CALIBRATE AXIS=[<axis>] [PEAK_POINT=<value>] [REPEATS=<value>]
```
По умолчанию калибровка совершит 10 итераций повышения/пониженя магнитуды
в диапазоне от `~0` до `rotation_distance * 1250`. После ее завершения вы
увидите в терминале путь до графического изображения, а так же модели. 
Открываем файл и видим примерно следующее - 

![](/wiki/pictures/img_1.png)

Как в терминале, так и на графике в таблице указано название модели и ее
среднеквадратичное отклонение (RMSE) от измеренных точек, отсортированное в
порядке возрастания. Берем функцию наименьшую по отклонению с параметрами
из терминала, дополнительно сверяем глазами ее на графике с точками и 
вписываем в конфигурационный файл. Например -
```
model: exponential
model_coeffs:
    68002.9000704507,
    0.0293145933,
    -70739.3609995888
```
### [Поддержать](https://ko-fi.com/altzbox) проект
### Контакты -  @altzbox @mrx8024 telegram / discord
