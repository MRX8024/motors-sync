## Добро пожаловать в проект синхронизации шаговых двигателей для 4wd систем

## О проекте

### В данный момент программа поддерживает следующие кинематики:
`CoreXY / Cartesian` `4 WD`

Метода синхронизации заключается в измерении величины смещения (колебаний)
печатающей головки (каретки), при включении второго шагового двигателя,
располагающегося на одном ремне с первым. Второй мотор смещается до
ближайщего полного шага, тем самым растягивая и ослабляя ремень по двум
сторонам контура, изза первого, удерживающего ремень, мотора. Удары
измеряет акселерометр, навсегда расположившийся на каретке, в зависимости
от типа кинематики. Синхронизация софтовая, а значит сбрасывается при
отключении любого из шаговых двигателей на контуре ремня.

Скрипт определяет направление движения, для уменьшения колебаний каретки.
Производит корректировку микрошагов до тех пор, пока величина смещений
уменьшается, т.е. пока мотор не начнет растягивание ремня в обратную
сторону. В этом случае калибровка завершается на микрошаге с наименьшей
величиной удара, либо совершает дополнительные итерации, для достижения
заданного порога колебаний n-ное кол-во раз.

### 1. Установка скрипта калибровки на хост принтера -

```
 cd ~
 git clone https://github.com/MRX8024/motors-sync
 bash ~/motors-sync/install.sh
```

2. Подключаем акселерометр, например как при измерении резонансов для
   input_shaper.
3. Добавляем в конфигурационный файл раздел, и частично настраиваем
   его для первого замера -

```
[motors_sync]
#accel_chip:
#    Aкселерометр для сбора вибраций adxl345 / mpu9250 / lis2dw и т.п.
#    По умолчанию используется акселерометр из [resonance_tester].
axes: x,y
#    Оси на которых будет производиться калибровка.
#microsteps: 16
#    Максимальное дробление смещения ротора шагового двигателя, не
#    стоит повышать значение выше 16, делайте это на свой страх и риск.
#model: linear (устаревший steps_threshold и steps_coeff)
#    Модель зависимости смещения микрошагов на валу шагового двигателя
#    от величины измеренных колебаний. Поддерживаемые модели: linear,
#    quadratic, cubic, power, root, hyperbolic, exponential.
#model_coeffs: 20000, 0
#    Коэффициенты выше описанной модели, для рассчета микрошагов.
#### MAX_STEP_SIZE ####
#
#
#
#fast_threshold: 999999
#    Порог, до которого мотор не будет совершать угасающие колебания,
#    ради экономии времени, ввиду и так высоких отклонений. Будьте 
#    очень осторожны, уменьшая значение этого параметра.
#retry_tolerance: 999999
#    Принудительный порог, до которого пара шаговых двигателей на
#    одном ремне, должна будет опустить величину колебаний.
#    Рекомендуется к настройке, дабы фильтровать возможные неточости.
#    После нескольких итераций запуска синхронизации вы найдете грань,  
#    до которой нужно опустить этот параметр.
#retries: 0
#    Максимальное количество повторений для достижения принудительного
#    порога отклонений синхронизации моторов.
```
4. Синхронизация моторов:
   Вводим команду `SYNC_MOTORS` в терминале, на главной странице веб
   интерфейса, и ждем завершения процесса.

   Некоторые параметры можно переопределять:
   ```
   SYNC_MOTORS [ACCEL_CHIP=<chip_name>] [FAST_THRESHOLD=<value>]
    [RETRY_TOLERANCE=<value>] [RETRIES=<value>]
   ```
   Для удобства настройки дополнительных параметров можно добавить макрос
   из `motors_sync.cfg` для получения физических кнопок\ячеек в интерфейсе.
5. Примечания:
   1. Не включайте нагрев хотенда во время синхронизации. Работающий
      вентилятор (в целом любой вентилятор в принтере) может помешать
      корректному и более точному измерению. Но если он вынужден быть
      включенным, постарайтесь не допускать его отключения посреди
      измерений. Измерить/cравнить шумы вы можете стандартной командой 
      клиппера - [MEASURE_AXES_NOISE
      ](https://www.klipper3d.org/G-Codes.html#measure_axes_noise)
6. Синхронизация обычно запускается в начале печати, во время нагрева
   стола. Для этого нужно добавить ее в макрос \ слайсер. Например -
```
M140 S   ;set bed temp
SYNC_MOTORS
G28 Z
M190 S   ; wait for bed temp to stabilize
M104 S   ;set extruder temp
...
```
7. Так же вводится переменная статуса калибровки, которая сбрасывается
   при выключении моторов принтера. Вы можете проверять её состояние
   внутри макроса, и в случае чего не делать лишний раз калибровку,
   если она была уже выполнена в текущий сеанс. Для примера -
```
...
G28 X Y
{% if not printer.motors_sync.applied %}
    SYNC_MOTORS
{% endif %}
G28 Z
...
```
### Калибровка модели синхронизации -
После того как вы убедились в должной работе всего процесса, у вас не
возникает случайных ошибочных измерений т.п., можно ускорить выполнение
синхронизации подбором подходящей модели зависимости микрошагов от
величины колебаний. Для этого вводим команду `SYNC_MOTORS_CALIBRATE` в
терминал, некоторые параметры так же можно переопределить:
```
SYNC_MOTORS_CALIBRATE [PEAK_POINT=<value>] [REPEATS=<value>]
```
По умолчанию калибровка совершит 10 итераций повышения/пониженя магнитуды
в диапазоне от ~0 до 50000. После ее завершения вы увидите в терминале
путь до графического изображения, а так же модели. Открывает файл и видим
примерно следующее - 
![](/wiki/pictures/img_1.png)
Как в терминале, так и на графике в таблице указано название модели и ее
среднеквадратичное отклонение от измеренных точек, отсортированное в
порядке возрастания. Берем функцию наименьшую по отклонению с параметрами
из терминала, дополнительно сверяем глазами ее на графике с точками и 
вписываем в конфигурационный файл. Например -
```
model: exponential
model_coeffs:
    68002.9000704507,
    0.0293145933,
    -70739.3609995888
```
### [Поддержать](https://ko-fi.com/altzbox) проект
### Контакты -  @altzbox @mrx8024 telegram / discord
